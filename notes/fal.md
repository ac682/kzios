# 文件系统抽象层

文件系统位于用户态，由提供者自行实现，这里讲的是位于内核的抽象层————Filesystem Abstract Layer。

## 抽象

从注册点开始，形成树状，枝为目录，叶为文件。
目录可以是挂载点，也可以是链接，或单纯目录，文件可以是流，属性，也可以是链接。

## 文件属性

无论是文件还是目录，元数据都包含属性表(Attributes)。标记(Flags)则是属性的基础部分，最常用的是RWX三元素。对于目录和文件这三个标记有不同的含义。

- Read: 文件内容可读，目录可枚举
- Write: 文件内容可改写，目录可增删文件
- eXecute: 文件可执行，目录可进入(以便枚举下一级目录文件)
  
上述三个还有对应的特权属性(Privileged-)，使用 `rW-` 来表示普通读+特权写。当标记中任意位存在其对应的特权版本时，该标记即要求特权，可以用表达式 `R--`+`rw-`=`Rw-` 表示。

## 接口

文件系统提供 `Access`，`Inspect` 和 `Modify` 系统调用用于检查修改一个文件的元数据。
针对不同文件有各对应的系统调用。

- 流(Stream)：`Open`，`Close`(直接 `sys_tunnel_dispose` 就行不需要额外加个系统调用来关)
- 属性(Property)：`Read`, `Write`
  
针对目录同样有一套系统调用。

- 创建链接、文件或目录: `Create`
- 删除链接、文件或目录: `Delete`
- 移动链接、文件或目录: `Move`
- 复制链接、文件或目录: `Copy`

**注意: 链接会转发对于 Dentry 的 `Access`，`Inspect`，和对于文件的 `Open`，`Close`，`Read`，`Write`。如果要检查链接或挂载点本身的信息，就需要在绝对路径最前面加个"@"来表示"本身"。**

使用文件绝对路径来查找目录或者文件。根目录的索引名为 ""(空字符)，理论上应该可以用空字符或 "/" 来代表根目录，但空字符不合法，所以只能用后者。

## 类型

不管何种类型，进程对文件或目录的所有操作都是通过进程调用系统调用进行。

内核根据文件路径找到节点，判断节点类型是否为文件，是(内核文件)则根据类型进一步操作。
如果是挂载点，则将文件路径相对于挂载点的部分打包成消息发送给文件系统服务进程，该系统调用转换为异步调用。

### 流

流使用隧道传输，成功打开流会得到一个隧道，内核文件会由内核创建隧道而外部文件则由文件系统服务进程创建隧道，隧道号用该系统调用的返回值传递给调用方。

### 属性

属性使用用户空间写字节传递，内核会将结果填充到进程提供的缓冲区。对于外部文件，需要用消息来直接传递值。
用户缓冲区的预设置大小在先前的 `Inspect` 中的 `size` 字段就能获得。

属性的值最大只能到 512 字节(一个文件 Block)。

属性有多种类型，文件属性表中可查。

- Integer，实际是64位有符号整数
- Integers，64位有符号整数的数组形式
- Decimal，实际是双精度浮点数
- Decimals，双精度浮点数的数组形式
- String，实际是 1 字节整数的数组形式
- Blob，8 位整数的数组形式，或者，字节集

挂载点可以指定是否支持目录，属性，流。数据库进程可以将自己当作文件系统服务进程挂载，并提供无目录仅属性的支持，其中属性不支持的数据类型使用 Blob 间接实现。

对于大于一个消息能传递的数据类型，使用多个消息来传递。

## 文件系统行为

通过抽象接口实现的文件系统 `FileSystem` 都必须假设自己为根文件系统，且只接受绝对路径的查询。内核有义务保证发送到文件系统实现的路径为绝对路径。

## 系统调用

获取节点是否存在 `Access`，提供路径所指向的节点是否存在和用于存放元数据交换结构的序列化大小。

使用 `Inspect` 提供路径和一个大小为任意(但最好是 `Access` 中得到的大小)的 byte buffer，和 buffer 的大小(当无法提供足够大的 buffer 时可以用于截断)。
Buffer 中将填充以下数据结构。通过其返回值表示写入的对象数量，来遍历列表。

```rust
struct DentryObject{
    kind: DentryType,
    attr: FlagSet<DentryAttribute>,
    created_at: Timestamp,
    modified_at: Timestamp,
    size: usize,
    in_use: bool,
    name_length: usize,
}
```

`name` 位于结构体后续 `name_length` 个字节，第二个结构体(只有为目录时存在后续结构体)位于名字后。
