# 文件系统抽象层

文件系统位于用户态，由提供者自行实现，这里讲的是位于内核的抽象层————Filesystem Abstract Layer。

## 抽象

从注册点开始，形成树状，枝为目录，叶为文件。
目录可以是挂载点，也可以是链接，或单纯目录，文件可以是流，属性，也可以是链接。

## 文件属性

无论是文件还是目录，元数据都包含属性表(Attributes)。标记(Flags)则是属性的基础部分，最常用的是RWX三元素。对于目录和文件这三个标记有不同的含义。

- Read: 文件内容可读，目录可枚举
- Write: 文件内容可改写，目录可增删文件
- eXecute: 文件可执行，目录可进入(以便枚举下一级目录文件)

## 接口

文件系统提供 `Inspect` 和 `Modify` 系统调用用于检查修改一个文件的元数据。
针对不同文件有各对应的系统调用。

- 流(Stream)：`Open`，`Close`
- 属性(Property)：`Read`, `Write`
  
链接则会讲操作转发到目标文件。
针对目录同样有一套系统调用。

- 创建文件或目录: `Create`
- 删除文件或目录: `Remove`

使用文件绝对路径来查找目录或者文件。根目录的索引名为 ""(空字符)，理论上应该可以用空字符或 "/" 来代表根目录，但空字符不合法，所以只能用后者。

## 类型

不管何种类型，进程对文件或目录的所有操作都是通过进程调用系统调用进行。

内核根据文件路径找到节点，判断节点类型是否为文件，是(内核文件)则根据类型进一步操作。
如果是挂载点，则将文件路径相对于挂载点的部分打包成消息发送给文件系统服务进程，该系统调用转换为异步调用。

### 流

流使用隧道传输，成功打开流会得到一个隧道，内核文件会由内核创建隧道而外部文件则由文件系统服务进程创建隧道，隧道号用该系统调用的返回值传递给调用方。

### 属性

属性使用用户空间写字节传递，内核会将结果填充到进程提供的缓冲区。对于外部文件，需要用消息来直接传递值。
用户缓冲区的预设置大小在先前的 `Inspect` 中就能获得。

属性的值最大只能到 512 字节(一个文件 Block)。

属性有多种类型，文件属性表中可查。

- Integer，实际是 64位 整数
- Integers，64位整数的数组形式
- Decimal，实际是双精度浮点数
- Decimals，双精度浮点数的数组形式
- String，实际是 1 字节整数的数组形式
- Blob，8 位整数的数组形式，或者，字节集

挂载点可以指定是否支持目录，属性，流。数据库进程可以将自己当作文件系统服务进程挂载，并提供无目录仅属性的支持，其中属性不支持的数据类型使用 Blob 间接实现。

对于大于一个消息能传递的数据类型，使用多个消息来传递。

## 文件系统行为

通过抽象接口实现的文件系统 `FileSystem` 都必须假设自己为根文件系统，且只接受绝对路径的查询。内核有义务保证发送到文件系统实现的路径为绝对路径。
