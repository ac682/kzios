# 进程与线程

进程是用户作业所需的资源，代码和上下文的统一管理对象，而调用这些资源和执行代码需要有执行单元————线程。

## 进程资源

初生代进程，由 board crate 创建，没有父进程，通常是服务和驱动，可以被直接在内核中被创建出来。次生代进程按树状结构，由初生代进程或其他次生代进程 fork 获得，父进程为其 fork 前的进程。进程拥有一片独立的地址空间，进程与进程之间内存互不干扰。进程由唯一的进程编号 PID 标志。

## 线程和其资源

线程是进程执行代码的基础单元，一个进程要想获得 CPU 资源必须具有一个以上的线程。线程在进程内共享地址空间，可以互相访问内存，具有独立的栈和线程编号 TID。线程是进程的私有资源，进程无法访问其他进程的线程，因此全局中 TID 不唯一，只在同一个进程中唯一。

### 主线程

进程在创建之初由内核进程管理部分赋予其执行的能力————为其创建一个主线程。主线程的编号固定或通常为 0。主线程的栈大小没有上线，位于主栈区。此后创建的线程栈大小都有限制，通常为 8MB，位于进程空间的中间位置向上分配并最终与主栈区碰撞。

## 进程空间

进程享有的地址空间由内核管理，进程只能决定自己的程序和数据段位置，且要求其尽可能位于低地址处。

![地址空间](./images/proc_mem.drawio.png)

## 线程栈区的分配与救援

栈的初始大小固定，但当其栈将要溢出时会尝试救援，扩大栈区为两倍大小直到无可用空间时发生奔溃。
栈区被划分为 8MB 大小的块，每个线程在创建时从下向上寻找并占有一个空闲块。当块讲被填满时，会检查位于下面的块是否被使用，没有的话则简单标记吞并，占有的话发生块迁移。

由于移动的是虚拟地址，因此不需要发生内存拷贝，只需在被使用的地址最高处块向上取足够大小，然后逐个把页映射转移过来，清除原先块的映射关系，标记原先块为未使用。
